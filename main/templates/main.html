{% extends 'base.html' %}

{% block meta %}
<title>PBP Tugas 5</title>
{% endblock meta %}

{% block content %}
{% include 'navbar.html' %}

<style>
.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 400px;
  text-align: center;
  padding: 2rem;
}

.empty-state.hidden {
  display: none !important;
}


</style>

<div class="relative overflow-hidden" style="background: linear-gradient(to right, #c3dfffff, #ff6b6bff);margin-right:-4rem; margin-left: -4rem; margin-top: -1rem">
  <div class="pt-16 pb-80 sm:pt-24 sm:pb-40 lg:pt-40 lg:pb-48">
    <div class="relative mx-auto max-w-7xl px-4 sm:static sm:px-6 lg:px-8">
      <div class="sm:max-w-lg">
        <h1 class="text-4xl font-bold tracking-tight text-gray-900 sm:text-6xl">
          Football Season Starts Here
        </h1>
        <p class="mt-4 text-xl text-gray-600">
            Kick off with our newest football gear. Jerseys, shoes, and accessories. Ready for every match and every fan!        
        </p>
      </div>

      <div class="mt-10">
        <!-- Decorative image grid -->
        <div aria-hidden="true"
          class="pointer-events-none lg:absolute lg:inset-y-0 lg:mx-auto lg:w-full lg:max-w-7xl">
          <div
            class="absolute transform sm:top-0 sm:left-1/2 sm:translate-x-8 lg:top-1/2 lg:left-1/2 lg:translate-x-8 lg:-translate-y-1/2">
            <div class="flex items-center space-x-6 lg:space-x-8">

              <div class="grid shrink-0 grid-cols-1 gap-y-6 lg:gap-y-8">
                <div class="h-64 w-44 overflow-hidden rounded-lg sm:opacity-0 lg:opacity-100">
                  <img
                    src="https://senikersku.com/wp-content/uploads/2024/07/1-61-scaled.jpg"
                    alt="" class="size-full object-cover" />
                </div>
                <div class="h-64 w-44 overflow-hidden rounded-lg">
                  <img
                    src="https://static.wixstatic.com/media/ab5830_dd4d5d4cd7f94cfba7fd98046108d211~mv2.jpeg/v1/fill/w_980,h_980,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/ab5830_dd4d5d4cd7f94cfba7fd98046108d211~mv2.jpeg"
                    alt="" class="size-full object-cover" />
                </div>
              </div>

              <div class="grid shrink-0 grid-cols-1 gap-y-6 lg:gap-y-8">
                <div class="h-64 w-44 overflow-hidden rounded-lg">
                  <img
                    src="https://media.istockphoto.com/id/171272361/photo/young-african-american-man-soccer-player.jpg?s=612x612&w=0&k=20&c=qRxLIyc8EFROkIjDe6KDN664Z-qmAoFuFnEvfFjt98g="
                    alt="" class="size-full object-cover" />
                </div>
                <div class="h-64 w-44 overflow-hidden rounded-lg">
                  <img
                    src="https://media.istockphoto.com/id/171272361/photo/young-african-american-man-soccer-player.jpg?s=612x612&w=0&k=20&c=qRxLIyc8EFROkIjDe6KDN664Z-qmAoFuFnEvfFjt98g="
                    alt="" class="size-full object-cover" />
                </div>
                <div class="h-64 w-44 overflow-hidden rounded-lg">
                  <img
                    src="https://jwanderson.com/cdn/shop/files/KW1427YN0458429_Ecomm_M_D5_a3475996-1218-4364-95e4-0e05538b5953.jpg?v=1756392326&width=2400"
                    alt="" class="size-full object-cover" />
                </div>
              </div>

              <div class="grid shrink-0 grid-cols-1 gap-y-6 lg:gap-y-8">
                <div class="h-64 w-44 overflow-hidden rounded-lg">
                  <img
                    src="https://www.static-src.com/wcsstore/Indraprastha/images/catalog/full/catalog-image/MTA-170041275/adidas_adidas_men_football_shorts_fortore_23_celana_bola_pria_-ik5736-_full02_b1c7c6aq.jpeg"
                    alt="" class="size-full object-cover" />
                </div>
                <div class="h-64 w-44 overflow-hidden rounded-lg">
                  <img
                    src="https://tailwindcss.com/plus-assets/img/ecommerce-images/home-page-03-hero-image-tile-07.jpg"
                    alt="" class="size-full object-cover" />
                </div>
              </div>

            </div>
          </div>
        </div>

        <a href="#konten">
        <button style="width: 12rem; height: 3rem">Shop Collection</button>
        </a>
      </div>
    </div>
  </div>
</div>

<div id="konten" style="display: flex; justify-content: space-between; align-items: center; margin: 4rem 0 2rem 0;">
  <h3 style="font: 600 32px 'Poppins', sans-serif; margin: 0;">Hi, {{ request.user.username }}!</h3>
  <div style="display: flex; gap: 1rem;">
    <button id="refreshBtn" style="width: 8rem;">Refresh</button>
    <button onclick="showModal()" style="width: 8rem;">+ Add Product</button>
  </div>
</div>

<div id="loading" class="bg-white rounded-lg border border-gray-200 p-12 text-center hidden">
  <svg class="animate-spin h-8 w-8 text-green-600 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
  </svg>
  <p class="text-gray-600 mt-3">Loading products...</p>
</div>

<div id="empty" class="empty-state" style="display: none">
  <svg xmlns="http://www.w3.org/2000/svg" style="width: 120px; height: 120px; margin-bottom: 1.5rem; opacity: 0.3;" fill="none" viewBox="0 0 24 24" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
  </svg>
  
  <h2 style="font-size: 24px; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
    No Products Yet
  </h2>
  <p style="font-size: 16px; color: #6b7280; margin-bottom: 2rem; max-width: 400px;">
      It looks like there are no products listed in this store. Start by adding your first product!
  </p>
  
    <button onclick="showModal()" style="width:124px">
      + Add Product
    </button>
</div>

<div id="product-container" class="product-container"></div>

<h5>Sesi terakhir login: {{ last_login }}</h5>
  <button class="logoutBtn btn-delete" style="width: 30%; margin-top: 1rem;">Logout</button>

<div id="deleteModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-lg p-6 w-80 text-center">
    <h2 class="text-lg font-semibold mb-2">Hapus produk ini?</h2>
    <p class="text-gray-600 mb-4">Tindakan ini tidak bisa dibatalkan.</p>
    <div class="flex justify-center gap-4">
      <button id="cancelDeleteBtn" class="px-4 py-2 border rounded-lg">Batal</button>
      <button id="confirmDeleteBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg">Hapus</button>
    </div>
  </div>
</div>

<script>
const PRODUCT_API_ENDPOINT = "{% url 'main:show_json' %}";
const CURRENT_USER_ID = "{{ user.id|default_if_none:'' }}";

const loadingSpinner = document.getElementById('loading');
const emptyStateDisplay = document.getElementById('empty');
const productContainer = document.getElementById('product-container');

let allProductsData = [];

function displayPageSection({ showLoading = false, showEmpty = false, showProducts = false }) {
  loadingSpinner.style.display = showLoading ? 'block' : 'none';
  emptyStateDisplay.style.display = showEmpty ? 'flex' : 'none';
  productContainer.style.display = showProducts ? 'grid' : 'none';
}

function buildProductCardElement(product) {
  const cardElement = document.createElement('div');
  cardElement.className = 'product-card';

  const productId = product.pk || product.id;
  const fields = product.fields || product;
  
  const detailLink = `{% url 'main:show_product' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', productId);
  const editLink = `{% url 'main:edit_product' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', productId);
  const deleteLink = `{% url 'main:delete_product' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', productId);

  const thumbnail = fields.thumbnail || '';
  const thumbnailHtml = thumbnail 
    ? `<img src='${thumbnail}' alt='${fields.name || ''}' class='size-full object-cover'>` 
    : `<div class='size-full bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center'></div>`;

  const description = fields.description || '';
  const truncatedDescription = description.split(' ').slice(0, 5).join(' ');
  
  const username = fields.user__username || fields.username || 'Anonymous';
  
  const productUserId = fields.user || fields.user_id;

  const editDeleteButtons = CURRENT_USER_ID && Number(CURRENT_USER_ID) === Number(productUserId)
    ? `<a href='${editLink}' class='flex-1'>
        <button class='btn-edit w-20'>Edit</button>
      </a>
      <button onclick="showDeleteModal('${productId}')" class="btn-delete w-full">Delete</button>
`
    : '';

  const completeCardHtml = `
    <div style="display: flex; justify-content: center; margin-bottom: 1rem;">
      <div class="h-56 w-44 overflow-hidden rounded-lg">
        ${thumbnailHtml}
      </div>
    </div>

    <h2 style="text-align: left; font: 600 20px 'Poppins', sans-serif; margin: 0;">
      <a href="${detailLink}">${fields.name || 'Untitled'}</a>
    </h2>

    <h3 style="text-align: left;">${fields.price || '0'}</h3>
    <p style="text-align: left !important; display: block; width: 100%;">${truncatedDescription}${description ? '...' : ''}</p>

    <div style="margin-top: auto; padding-top: 1rem;">
      <p style="margin-bottom: 0.5rem;">Added by: ${username}</p>

      <div class="flex gap-1">
        <a href="${detailLink}" class="flex-[2]">
          <button class="w-40">See Details</button>
        </a>
        ${editDeleteButtons}
      </div>
    </div>
  `;

  cardElement.innerHTML = completeCardHtml;
  return cardElement;
}
document.getElementById('refreshBtn').addEventListener('click', () => {
  fetchProductsFromServer();
});
function renderAllProductCards(products) {
  productContainer.innerHTML = '';
  products.forEach(product => {
    const cardElement = buildProductCardElement(product);
    productContainer.appendChild(cardElement);
  });
}

function displayProducts() {
  productContainer.innerHTML = '';

  if (allProductsData.length === 0) {
    displayPageSection({ showEmpty: true, showProducts: false, showLoading: false });
  } else {
    renderAllProductCards(allProductsData);
    displayPageSection({ showProducts: true, showEmpty: false, showLoading: false });
  }
}

async function fetchProductsFromServer() {
  try {
    displayPageSection({ showLoading: true });
    
    const response = await fetch(PRODUCT_API_ENDPOINT, {
      headers: { 'Accept': 'application/json' },
    });

    if (!response.ok) {
      throw new Error('Failed to fetch products data from server');
    }

    const productsData = await response.json();
    console.log('Products data received:', productsData);
    console.log('Number of products:', productsData.length);
    
    allProductsData = productsData || [];
    
    displayProducts();
  } catch (error) {
    console.error('Error loading products:', error);
    displayPageSection({ showEmpty: true });
  }
}

document.addEventListener('productAdded', function() {
    fetchProductsFromServer();
});

function initializeProductPage() {
  fetchProductsFromServer();
}

initializeProductPage();

document.querySelectorAll('.logoutBtn').forEach(btn => {
  btn.addEventListener('click', function() {
    fetch("{% url 'main:logout' %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
      },
    })
    .then(response => {
      if (response.ok) {
        showToast("Berhasil logout!", "Sampai jumpa lagi!");
        setTimeout(() => {
          window.location.href = "{% url 'main:login' %}";
        }, 1500);
      } else {
        showToast("Logout gagal!", "error");
      }
    })
    .catch(() => showToast("Terjadi kesalahan!", "error"));
  });
});

let productIdToDelete = null;

function showDeleteModal(productId) {
  productIdToDelete = productId;
  document.getElementById('deleteModal').classList.remove('hidden');
}

function hideDeleteModal() {
  document.getElementById('deleteModal').classList.add('hidden');
  productIdToDelete = null;
}

document.getElementById('cancelDeleteBtn').addEventListener('click', hideDeleteModal);
document.getElementById('confirmDeleteBtn').addEventListener('click', async function() {
  if (!productIdToDelete) return;

  try {
    const deleteUrl = `{% url 'main:delete_product' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', productIdToDelete);
    
    const response = await fetch(deleteUrl, {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
      },
    });

    if (response.ok) {
      showToast("Produk dihapus!", "Produk berhasil dihapus dari katalog", "success");
      hideDeleteModal();
      fetchProductsFromServer(); 
    } else {
      showToast("Gagal menghapus produk!", "Terjadi kesalahan saat menghapus", "error");
    }
  } catch (error) {
    showToast("Gagal!", "Tidak bisa terhubung ke server", "error");
  }
});


</script>

{% endblock content %}