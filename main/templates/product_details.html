{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Product Details</title>
{% endblock meta %}

{% block content %}

<!-- Loading State -->
<div id="loading-state" style="max-width: 800px; margin: 0 auto; padding: 2rem; text-align: center;">
    <svg style="animation: spin 1s linear infinite; height: 2rem; width: 2rem; display: inline-block;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle style="opacity: 0.25;" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path style="opacity: 0.75;" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
    </svg>
    <p style="margin-top: 1rem; color: #6b7280;">Loading product details...</p>
</div>

<!-- Error State -->
<div id="error-state" style="max-width: 800px; margin: 0 auto; padding: 2rem; text-align: center; display: none;">
    <div style="font-size: 3rem; margin-bottom: 1rem;">⚠️</div>
    <h3 style="font-size: 1.125rem; font-weight: 500; margin-bottom: 0.5rem;">Failed to load product</h3>
    <p style="color: #6b7280;">Please try again later.</p>
</div>

<!-- Product Content -->
<div id="product-content" style="max-width: 800px; margin: 0 auto; padding: 2rem; display: none;">
    <!-- Back Button -->
    <a href="{% url 'main:show_main' %}">
        <button style="width: 14rem; padding: 0.5rem; margin-bottom: 2rem;">
            ← Back to Product List
        </button>
    </a>

    <!-- Product Details -->
    <div style="text-align: center;">
        <h1 id="product-name" style="font: 600 32px 'Poppins', sans-serif; margin-bottom: 1rem;">
            <!-- Product name will be inserted here -->
        </h1>

        <div id="product-image-container" style="margin: 2rem 0; display: none;">
            <img id="product-image" src="" alt="Product thumbnail" 
                 style="max-width: 100%; height: auto; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
        </div>

        <h3 id="product-price" style="font-size: 28px; color: #1c1975ff; font-weight: 700; margin: 1rem 0; text-align: left">
            <!-- Price will be inserted here -->
        </h3>

        <div style="text-align: left; margin-top: 2rem; line-height: 1.8;">
            <h4 style="font-size: 18px; font-weight: 600; margin-bottom: 0.5rem;">Description:</h4>
            <p id="product-description" style="color: #4b5563;">
                <!-- Description will be inserted here -->
            </p>
        </div>

        <!-- Action Buttons (Optional) -->
        <div id="action-buttons" style="display: none; gap: 1rem; margin-top: 3rem; justify-content: center;">
            <a id="edit-link" href="#" style="flex: 1; max-width: 200px;">
                <button style="width: 100%;">Edit Product</button>
            </a>
            <a id="delete-link" href="#" style="flex: 1; max-width: 200px;">
                <button class="btn-delete" style="width: 100%;">Delete Product</button>
            </a>
        </div>
    </div>
</div>

<script>
// Configuration
const PRODUCT_ID = "{{ product.id }}";
const PRODUCT_DETAIL_ENDPOINT = `{% url 'main:show_json_byId' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', PRODUCT_ID);
const IS_AUTHENTICATED = {{ user.is_authenticated|yesno:"true,false" }};
const CURRENT_USER_ID = "{{ user.id }}";

// DOM Elements
const loadingState = document.getElementById('loading-state');
const errorState = document.getElementById('error-state');
const productContent = document.getElementById('product-content');
const productName = document.getElementById('product-name');
const productImageContainer = document.getElementById('product-image-container');
const productImage = document.getElementById('product-image');
const productPrice = document.getElementById('product-price');
const productDescription = document.getElementById('product-description');
const actionButtons = document.getElementById('action-buttons');
const editLink = document.getElementById('edit-link');
const deleteLink = document.getElementById('delete-link');

function showState(state) {
    if (state === 'loading') {
        loadingState.style.display = 'block';
        errorState.style.display = 'none';
        productContent.style.display = 'none';
    } else if (state === 'error') {
        loadingState.style.display = 'none';
        errorState.style.display = 'block';
        productContent.style.display = 'none';
    } else if (state === 'ready') {
        loadingState.style.display = 'none';
        errorState.style.display = 'none';
        productContent.style.display = 'block';
    }
}

function renderProduct(product) {
    const productData = product.fields || product;
    
    const name = productData.name || product.name;
    productName.textContent = name;
    document.title = `${name} - Product Details`;
    
    const thumbnail = productData.thumbnail || product.thumbnail;
    if (thumbnail) {
        productImage.src = thumbnail;
        productImage.alt = name;
        productImageContainer.style.display = 'block';
    } else {
        productImageContainer.style.display = 'none';
    }
    
    const price = productData.price || product.price;
    productPrice.textContent = price || 'Price not available';
    
    const description = productData.description || product.description;
    productDescription.textContent = description || 'No description available';
    
    const productUserId = product.user || productData.user || (product.fields && product.fields.user);
    if (IS_AUTHENTICATED && productUserId && productUserId.toString() === CURRENT_USER_ID) {
        editLink.href = `{% url 'main:edit_product' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', PRODUCT_ID);
        deleteLink.href = `{% url 'main:delete_product' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', PRODUCT_ID);
        actionButtons.style.display = 'flex';
    } else {
        actionButtons.style.display = 'none';
    }
}

async function loadProductDetail() {
    try {
        showState('loading');
        
        const response = await fetch(PRODUCT_DETAIL_ENDPOINT, {
            headers: { 'Accept': 'application/json' },
        });

        if (!response.ok) {
            throw new Error('Failed to fetch product detail');
        }

        const productData = await response.json();
        
        const product = Array.isArray(productData) ? productData[0] : productData;
        
        renderProduct(product);
        showState('ready');
    } catch (error) {
        console.error('Error loading product detail:', error);
        showState('error');
    }
}

const style = document.createElement('style');
style.textContent = `
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
`;
document.head.appendChild(style);

loadProductDetail();
</script>

{% endblock content %}